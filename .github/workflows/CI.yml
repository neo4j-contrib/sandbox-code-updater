name: Sandbox Code Batch Updater CI

on:
  push:
    branches: [ 'main' ]
  pull_request:
    branches: [ '**' ]
  repository_dispatch:
    types: [ 'template-code-changes' ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    - name: Cache local Maven repository
      uses: actions/cache@v2
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    - name: Build with Maven
      run: mvn --show-version --batch-mode verify
  update-sandboxes:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    - name: Cache local Maven repository
      uses: actions/cache@v2
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    - name: Set up Git config
      run: |
        git config --global user.name "Sandbox ðŸ¤–"
        git config --global user.email ${{ secrets.EMAIL }}
    - name: Clone neo4j-graph-examples/template repo
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN }}
      run: |
        git clone https://$GITHUB_TOKEN@github.com/neo4j-graph-examples/template/
    - name: Run updater against sandboxes
      env:
        GITHUB_USERNAME: ${{ secrets.USERNAME }}
        GITHUB_TOKEN: ${{ secrets.TOKEN }}
        SANDBOX_CODE_SAMPLES_PATH: ${{ github.workspace }}/template
#        SANDBOX_REPOSITORIES_1: https://github.com/neo4j-graph-examples/pole.git
#        SANDBOX_REPOSITORIES_2: https://github.com/neo4j-graph-examples/graph-data-science.git
#        SANDBOX_REPOSITORIES_3: https://github.com/neo4j-graph-examples/bloom.git
#        SANDBOX_REPOSITORIES_4: https://github.com/neo4j-graph-examples/icij-paradise-papers.git
#        SANDBOX_REPOSITORIES_5: https://github.com/neo4j-graph-examples/northwind.git
#        SANDBOX_REPOSITORIES_6: https://github.com/neo4j-graph-examples/twitter-trolls.git
#        SANDBOX_REPOSITORIES_7: https://github.com/neo4j-graph-examples/fraud-detection.git
#        SANDBOX_REPOSITORIES_8: https://github.com/neo4j-graph-examples/fincen.git
#        SANDBOX_REPOSITORIES_9: https://github.com/neo4j-graph-examples/contact-tracing.git
#        SANDBOX_REPOSITORIES_10: https://github.com/neo4j-graph-examples/movies.git
#        SANDBOX_REPOSITORIES_11: https://github.com/neo4j-graph-examples/icij-panama-papers.git
#        SANDBOX_REPOSITORIES_12: https://github.com/neo4j-graph-examples/recommendations.git
#        SANDBOX_REPOSITORIES_13: https://github.com/neo4j-graph-examples/wwc2019.git
#        SANDBOX_REPOSITORIES_14: https://github.com/neo4j-graph-examples/legis-graph.git
#        SANDBOX_REPOSITORIES_15: https://github.com/neo4j-graph-examples/network-management.git
#        SANDBOX_REPOSITORIES_16: https://github.com/neo4j-graph-examples/blank-sandbox
      run: >
        mvn --show-version --batch-mode spring-boot:run -Dspring-boot.run.arguments=--logging.level.com.neo4j=TRACE
